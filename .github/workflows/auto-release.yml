name: Auto Release on Issue Close

on:
  issues:
    types: [closed]
  workflow_dispatch:
    inputs:
      issue_number:
        description: 'Issue number to create release for'
        required: true
        type: string
      version_bump:
        description: 'Version bump type'
        required: true
        type: choice
        options:
          - patch
          - minor
          - major
        default: 'patch'

permissions:
  contents: write
  issues: write

jobs:
  auto-release:
    name: Create Automatic Release
    runs-on: ubuntu-latest
    # Only run if issue was closed as completed (not just closed)
    if: github.event_name == 'workflow_dispatch' || github.event.issue.state_reason == 'completed'

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine Version Bump
        id: version
        env:
          ISSUE_TITLE: ${{ github.event.issue.title || 'Manual release' }}
          ISSUE_BODY: ${{ github.event.issue.body || '' }}
          ISSUE_LABELS: ${{ toJson(github.event.issue.labels) }}
          MANUAL_BUMP: ${{ github.event.inputs.version_bump || '' }}
        run: |
          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

          # Determine version bump type
          BUMP_TYPE="patch"

          if [ -n "$MANUAL_BUMP" ]; then
            BUMP_TYPE="$MANUAL_BUMP"
          elif echo "$ISSUE_LABELS" | grep -qi "breaking"; then
            BUMP_TYPE="major"
          elif echo "$ISSUE_LABELS" | grep -qi "feature\|enhancement"; then
            BUMP_TYPE="minor"
          elif echo "$ISSUE_LABELS" | grep -qi "bug\|fix"; then
            BUMP_TYPE="patch"
          fi

          echo "Bump type: $BUMP_TYPE"

          # Calculate new version
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Update Cargo.toml
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          awk -v new_ver="$NEW_VERSION" '
            BEGIN { in_package = 0 }
            /^\[package\]/ { in_package = 1; print; next }
            /^\[.*\]/ {
              if ($0 !~ /^\[package\]/) {
                in_package = 0
              }
              print
              next
            }
            in_package && /^version = "/ {
              sub(/^version = "[^"]*"/, "version = \"" new_ver "\"")
              print
              next
            }
            { print }
          ' Cargo.toml > Cargo.toml.tmp
          mv Cargo.toml.tmp Cargo.toml
          echo "Updated Cargo.toml to version $NEW_VERSION"

      - name: Update CHANGELOG.md
        env:
          ISSUE_NUMBER: ${{ github.event.issue.number || github.event.inputs.issue_number }}
          ISSUE_TITLE: ${{ github.event.issue.title || 'Manual release' }}
          ISSUE_URL: ${{ github.event.issue.html_url || '' }}
        run: |
          # Get current date
          RELEASE_DATE=$(date +%Y-%m-%d)
          NEW_VERSION="${{ steps.version.outputs.new_version }}"

          # Create new changelog entry
          {
            echo "## [$NEW_VERSION] - $RELEASE_DATE"
            echo ""
            echo "### Changed"
            echo "- Resolved issue #$ISSUE_NUMBER: $ISSUE_TITLE"
            echo ""
          } > /tmp/changelog_entry.md

          # Insert new entry after the header
          if [ -f CHANGELOG.md ]; then
            # Find the line number after the header (after "## [" pattern first occurs)
            LINE_NUM=$(grep -n "^## \[" CHANGELOG.md | head -1 | cut -d: -f1)
            if [ -n "$LINE_NUM" ]; then
              # Insert before the first version entry
              head -n $((LINE_NUM - 1)) CHANGELOG.md > /tmp/changelog_new.md
              cat /tmp/changelog_entry.md >> /tmp/changelog_new.md
              tail -n +$LINE_NUM CHANGELOG.md >> /tmp/changelog_new.md
              mv /tmp/changelog_new.md CHANGELOG.md
            else
              # No existing entries, append to the end
              cat /tmp/changelog_entry.md >> CHANGELOG.md
            fi
          else
            # Create new changelog
            {
              echo "# Changelog"
              echo ""
              echo "All notable changes to this project will be documented in this file."
              echo ""
              echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),"
              echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
              echo ""
            } > CHANGELOG.md
            cat /tmp/changelog_entry.md >> CHANGELOG.md
          fi

          echo "Updated CHANGELOG.md with version $NEW_VERSION"

      - name: Commit and Push Changes
        run: |
          git add Cargo.toml CHANGELOG.md
          git commit -m "Release v${{ steps.version.outputs.new_version }} - Issue #${{ github.event.issue.number || github.event.inputs.issue_number }}"
          git push origin ${{ github.ref_name }}

      - name: Create and Push Tag
        run: |
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }} - Issue #${{ github.event.issue.number || github.event.inputs.issue_number }}: ${{ github.event.issue.title || 'Manual release' }}"
          git push origin "v${{ steps.version.outputs.new_version }}"

      - name: Add Comment to Issue
        if: github.event_name == 'issues'
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh issue comment ${{ github.event.issue.number }} --body "ðŸš€ Automatic release **v${{ steps.version.outputs.new_version }}** has been triggered for this issue. The release will be available shortly at https://github.com/${{ github.repository }}/releases/tag/v${{ steps.version.outputs.new_version }}"
