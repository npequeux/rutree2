name: Auto Version on Commit

on:
  push:
    branches:
      - main
    paths-ignore:
      - '**.md'
      - 'docs/**'
      - '.github/**'
      - 'LICENSE'

permissions:
  contents: write

jobs:
  auto-version:
    name: Auto Version and Release
    runs-on: ubuntu-latest
    # Skip if commit message contains [skip-release] or if it's a release commit
    if: |
      !contains(github.event.head_commit.message, '[skip-release]') &&
      !startsWith(github.event.head_commit.message, 'Release v')

    steps:
      - name: Checkout code
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Rust
        uses: actions-rust-lang/setup-rust-toolchain@v1
        with:
          toolchain: stable

      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

      - name: Determine Version Bump
        id: version
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
        run: |
          # Get current version from Cargo.toml
          CURRENT_VERSION=$(grep '^version = ' Cargo.toml | head -1 | sed 's/version = "\(.*\)"/\1/')
          echo "Current version: $CURRENT_VERSION"

          # Parse version components
          MAJOR=$(echo $CURRENT_VERSION | cut -d. -f1)
          MINOR=$(echo $CURRENT_VERSION | cut -d. -f2)
          PATCH=$(echo $CURRENT_VERSION | cut -d. -f3)

          # Determine version bump type from commit message
          # Default to minor bump as per requirements
          BUMP_TYPE="minor"

          # Check for explicit version bump indicators in commit message
          if echo "$COMMIT_MESSAGE" | grep -qi "\[major\]"; then
            BUMP_TYPE="major"
          elif echo "$COMMIT_MESSAGE" | grep -qi "\[patch\]"; then
            BUMP_TYPE="patch"
          fi

          echo "Bump type: $BUMP_TYPE (default: minor)"

          # Calculate new version
          case $BUMP_TYPE in
            major)
              MAJOR=$((MAJOR + 1))
              MINOR=0
              PATCH=0
              ;;
            minor)
              MINOR=$((MINOR + 1))
              PATCH=0
              ;;
            patch)
              PATCH=$((PATCH + 1))
              ;;
          esac

          NEW_VERSION="${MAJOR}.${MINOR}.${PATCH}"
          echo "New version: $NEW_VERSION"

          echo "current_version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          echo "new_version=$NEW_VERSION" >> $GITHUB_OUTPUT
          echo "bump_type=$BUMP_TYPE" >> $GITHUB_OUTPUT

      - name: Update Cargo.toml
        run: |
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          awk -v new_ver="$NEW_VERSION" '
            BEGIN { in_package = 0 }
            /^\[package\]/ { in_package = 1; print; next }
            /^\[.*\]/ {
              if ($0 !~ /^\[package\]/) {
                in_package = 0
              }
              print
              next
            }
            in_package && /^version = "/ {
              sub(/^version = "[^"]*"/, "version = \"" new_ver "\"")
              print
              next
            }
            { print }
          ' Cargo.toml > Cargo.toml.tmp
          mv Cargo.toml.tmp Cargo.toml
          echo "Updated Cargo.toml to version $NEW_VERSION"

      - name: Update CHANGELOG.md
        env:
          COMMIT_MESSAGE: ${{ github.event.head_commit.message }}
          COMMIT_SHA: ${{ github.event.head_commit.id }}
          COMMIT_URL: ${{ github.event.head_commit.url }}
        run: |
          # Get current date
          RELEASE_DATE=$(date +%Y-%m-%d)
          NEW_VERSION="${{ steps.version.outputs.new_version }}"
          
          # Get first line of commit message (title)
          COMMIT_TITLE=$(echo "$COMMIT_MESSAGE" | head -1)

          # Create new changelog entry
          {
            echo "## [$NEW_VERSION] - $RELEASE_DATE"
            echo ""
            echo "### Changed"
            echo "- $COMMIT_TITLE ([${COMMIT_SHA:0:7}]($COMMIT_URL))"
            echo ""
          } > /tmp/changelog_entry.md

          # Insert new entry after the header
          if [ -f CHANGELOG.md ]; then
            # Find the line number after the header (after "## [" pattern first occurs)
            LINE_NUM=$(grep -n "^## \[" CHANGELOG.md | head -1 | cut -d: -f1)
            if [ -n "$LINE_NUM" ]; then
              # Insert before the first version entry
              head -n $((LINE_NUM - 1)) CHANGELOG.md > /tmp/changelog_new.md
              cat /tmp/changelog_entry.md >> /tmp/changelog_new.md
              tail -n +$LINE_NUM CHANGELOG.md >> /tmp/changelog_new.md
              mv /tmp/changelog_new.md CHANGELOG.md
            else
              # No existing entries, append to the end
              cat /tmp/changelog_entry.md >> CHANGELOG.md
            fi
          else
            # Create new changelog
            {
              echo "# Changelog"
              echo ""
              echo "All notable changes to this project will be documented in this file."
              echo ""
              echo "The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),"
              echo "and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html)."
              echo ""
            } > CHANGELOG.md
            cat /tmp/changelog_entry.md >> CHANGELOG.md
          fi

          echo "Updated CHANGELOG.md with version $NEW_VERSION"

      - name: Commit and Push Changes
        run: |
          git add Cargo.toml CHANGELOG.md
          git commit -m "Release v${{ steps.version.outputs.new_version }} [skip-release]"
          git push origin HEAD:refs/heads/main

      - name: Create and Push Tag
        run: |
          git tag -a "v${{ steps.version.outputs.new_version }}" -m "Release v${{ steps.version.outputs.new_version }}"
          git push origin "refs/tags/v${{ steps.version.outputs.new_version }}"
